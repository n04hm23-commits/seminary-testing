name: Ejecutar tests con Vitest

on:
  workflow_dispatch:
  workflow_call:
    inputs:
      input_artifact:
        type: string
        required: false
        default: "site-minified"

jobs:
  test:
    name: Vitest
    runs-on: ubuntu-latest
    steps:
      - name: Checkout (necesario para package-lock y tests)
        uses: actions/checkout@v5

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "24"

      # Solo cuando lo llama el orquestador: trae el sitio minificado
      - name: Descargar artifact minificado
        if: github.event_name == 'workflow_call'
        uses: actions/download-artifact@v4
        with:
          name: ${{ inputs.input_artifact }}
          path: site

      - name: Reemplazar assets por los minificados (solo workflow_call)
        if: github.event_name == 'workflow_call'
        run: |
          # Copia TODOS los CSS/JS minificados desde site/ a la misma ruta en el workspace
          # (rsync crea carpetas y sobreescribe)
          rsync -av \
            --include='*/' \
            --include='*.css' \
            --include='*.js' \
            --exclude='*' \
            site/ ./

      - name: Instalar dependencias (usa package-lock del repo)
        run: npm ci

      - name: Ejecutar pruebas
        run: npm test
